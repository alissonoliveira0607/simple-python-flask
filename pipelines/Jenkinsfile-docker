podTemplate(containers: [
    containerTemplate(
        name: 'docker',
        image: 'docker:dind',
        command: 'sleep',
        args: '99d',
        ttyEnabled: true,
        privileged: true
    )
],
volumes: [ hostPathVolume(hostPath: '/var/run/docker.sock', mountPath: '/var/run/docker.sock') ]
){


    node(POD_LABEL)
    {
        container('docker'){
            git 'https://github.com/alissonoliveira0607/simple-python-flask.git'
        }
    }

//    stages {
        // Stage de build da imagem para a aplicação
        stage("Build") {
            sh "docker build -t simple-python-flask:${BUILD_ID} ."
            
        }
        
        // Stage de testes para validar o build da imagem
        stage("Teste") {
           
                sh "docker run -d -ti --rm --name simple-python-flask:${BUILD_ID} simple-python-flask:${BUILD_ID}"  // Inicia um container com a imagem que foi buildada
                sh "docker exec simple-python-flask:${BUILD_ID} nosetests --with-xunit --with-coverage --cover-package=project test_users.py" // Executa um comando no container
        }

    post {
        success {
            echo "Pipeline executada com sucesso"
        }
        failure {
            echo "Pipeline Falhou"
        }
        cleanup {
            sh "docker stop simple-python-flask:${BUILD_ID}"
        }
    }
}
