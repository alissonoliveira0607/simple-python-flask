podTemplate(containers: [
    containerTemplate(
        name: 'docker',
        image: 'docker:dind',
        command: 'sleep',
        args: '99d',
        ttyEnabled: true,
        privileged: true
    )
],
volumes: [
    hostPathVolume(
        hostPath: '/var/run/docker.sock',
        mountPath: '/var/run/docker.sock'
    )
]) {

    pipeline {
        agent {
            label POD_LABEL
        }


        // Checkout do código
        container('docker') {
            git 'https://github.com/alissonoliveira0607/simple-python-flask.git'
        }

        // Build da imagem
        container('docker') {
            sh "docker build -t simple-python-flask:${BUILD_ID} ."
        }

        // Execução dos testes
        container('docker') {
            sh """
                docker run -d -ti --rm --name simple-python-flask:${BUILD_ID} simple-python-flask:${BUILD_ID}
                docker exec simple-python-flask:${BUILD_ID} nosetests --with-xunit --with-coverage --cover-package=project test_users.py
            """
        }

        post {
            success {
                echo "Pipeline executada com sucesso"
            }
            failure {
                echo "Pipeline falhou"
            }
            cleanup {
                container('docker') {
                    sh "docker stop simple-python-flask:${BUILD_ID}"
                }
            }
        }
    }
}
